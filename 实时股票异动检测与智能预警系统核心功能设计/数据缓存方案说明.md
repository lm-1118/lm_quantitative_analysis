# 📦 数据缓存方案说明

## 🎯 为什么需要数据缓存？

**Tushare免费版限制**：
- `stock_basic` 接口：**每小时只能调用1次**
- `daily` 接口：每分钟调用次数有限制
- 频繁调用会被限制访问

**解决方案**：
- ✅ 数据存储到MySQL数据库
- ✅ 优先从数据库读取
- ✅ 数据库没有时才从Tushare获取
- ✅ 支持手动同步更新

---

## 📊 数据库表结构

### 1. 股票基本信息表 (`stock_basic`)

**已存在的表**:
```sql
CREATE TABLE stock_basic (
    ts_code VARCHAR(20) PRIMARY KEY COMMENT 'TS代码',
    symbol VARCHAR(20) COMMENT '股票代码',
    name VARCHAR(100) COMMENT '股票名称',
    area VARCHAR(100) COMMENT '地域',
    industry VARCHAR(100) COMMENT '所属行业',
    list_date DATE COMMENT '上市日期'
);
```

**用途**：
- 存储所有A股上市公司基本信息
- 支持按行业、地域筛选
- 约5000条数据

---

### 2. 日线数据表 (`stock_daily_history`)

**已存在的表**:
```sql
CREATE TABLE stock_daily_history (
    ts_code VARCHAR(20) COMMENT '股票代码',
    trade_date VARCHAR(8) COMMENT '交易日期YYYYMMDD',
    open DECIMAL(10,2) COMMENT '开盘价',
    high DECIMAL(10,2) COMMENT '最高价',
    low DECIMAL(10,2) COMMENT '最低价',
    close DECIMAL(10,2) COMMENT '收盘价',
    pre_close DECIMAL(10,2) COMMENT '昨收价',
    change DECIMAL(10,2) COMMENT '涨跌额',
    pct_chg DECIMAL(10,2) COMMENT '涨跌幅%',
    vol BIGINT COMMENT '成交量',
    amount DECIMAL(20,2) COMMENT '成交额',
    PRIMARY KEY (ts_code, trade_date)
);
```

**用途**：
- 存储股票每日K线数据
- 用于图表展示
- 约5000只股票 × 250天/年 = 125万条/年

---

## 🔄 数据缓存逻辑

### 流程图

```
前端请求股票列表
      ↓
   查询数据库
      ↓
  有数据？ ─→ 是 ─→ 返回数据库数据
      ↓
     否
      ↓
调用Tushare API
      ↓
  保存到数据库
      ↓
   返回数据
```

---

## 🚀 新增API接口

### 1. 获取股票列表（带缓存）

**接口**: `GET /api/stocks`

**参数**:
- `industry`: 行业筛选（可选）
- `area`: 地域筛选（可选）
- `page`: 页码（默认1）
- `page_size`: 每页数量（默认50）

**响应示例**:
```json
{
  "success": true,
  "data": [...],
  "total": 5000,
  "page": 1,
  "page_size": 50,
  "total_pages": 100,
  "source": "database"
}
```

**缓存逻辑**:
1. 优先从数据库查询
2. 如果数据库为空，自动调用Tushare同步
3. 同步后再次查询数据库
4. `source`字段表明数据来源

---

### 2. 手动同步股票列表

**接口**: `POST /api/stocks/sync`

**请求体**:
```json
{
  "force_update": false
}
```

**参数说明**:
- `force_update`: 是否强制更新（默认false）
  - `false`: 数据库有数据则跳过
  - `true`: 强制从Tushare重新获取

**响应示例**:
```json
{
  "success": true,
  "message": "同步成功",
  "added": 100,
  "updated": 4900,
  "total": 5000,
  "source": "tushare"
}
```

**使用场景**:
- 首次使用系统时调用一次
- 每周/每月更新一次股票列表
- 发现新股上市时

---

### 3. 获取日线数据（带缓存）

**接口**: `GET /api/stocks/{ts_code}/daily`

**参数**:
- `start_date`: 开始日期 YYYYMMDD（可选）
- `end_date`: 结束日期 YYYYMMDD（可选）
- `limit`: 返回条数（默认60）

**响应示例**:
```json
{
  "success": true,
  "data": [
    {
      "ts_code": "000001.SZ",
      "trade_date": "20230930",
      "open": 12.50,
      "high": 12.80,
      "low": 12.45,
      "close": 12.75,
      "pct_chg": 2.00,
      "vol": 150000,
      "amount": 187500
    }
  ],
  "source": "database"
}
```

**缓存逻辑**:
1. 优先从数据库查询
2. 如果数据库为空，自动调用Tushare获取
3. 保存到数据库后返回

---

### 4. 手动同步日线数据

**接口**: `POST /api/stocks/{ts_code}/daily/sync`

**请求体**:
```json
{
  "start_date": "20230901",
  "end_date": "20230930"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "同步成功",
  "added": 20,
  "source": "tushare"
}
```

**使用场景**:
- 补充历史数据
- 更新最新交易日数据

---

## 💡 使用建议

### 初次使用

**步骤1**: 同步股票列表
```bash
POST /api/stocks/sync
{
  "force_update": true
}
```

**步骤2**: 前端正常调用
```bash
GET /api/stocks?page=1&page_size=50
```

以后所有请求都会自动从数据库读取，**不会再调用Tushare**！

---

### 日常使用

**获取股票列表**:
```
GET /api/stocks?industry=银行
```
→ 直接从数据库读取，秒级响应 ⚡

**获取K线数据**:
```
GET /api/stocks/000001.SZ/daily?limit=30
```
→ 第一次会从Tushare获取并缓存  
→ 以后都从数据库读取 ⚡

---

### 定期更新

**每周更新股票列表**（新股上市）:
```bash
POST /api/stocks/sync
{
  "force_update": true
}
```

**每日更新K线数据**（可选，定时任务）:
```bash
POST /api/stocks/000001.SZ/daily/sync
{
  "start_date": "20230930",
  "end_date": "20230930"
}
```

---

## 🎯 优势总结

### ✅ 解决API限制
- 避免频繁调用Tushare
- 不受每小时1次的限制
- 数据响应更快

### ✅ 提升性能
- 数据库查询比API调用快10倍以上
- 支持分页、筛选
- 支持SQL聚合查询

### ✅ 数据持久化
- 历史数据永久保存
- 支持离线使用
- 可以做数据分析

### ✅ 灵活控制
- 可以选择何时更新
- 支持强制刷新
- 支持批量同步

---

## 📝 下一步工作

### 待实现功能

1. **定时任务**（APScheduler）
   - 每日收盘后自动更新K线数据
   - 每周自动更新股票列表

2. **增量更新**
   - 只更新缺失的日期
   - 避免重复数据

3. **数据清理**
   - 定期清理过期数据
   - 压缩历史数据

4. **缓存优化**
   - Redis缓存热门数据
   - LRU淘汰机制

---

## 🔧 技术实现

### StockDataService核心方法

```python
class StockDataService:
    
    @staticmethod
    def get_stock_list(industry, area, page, page_size):
        """
        1. 查询数据库
        2. 如果为空，调用sync_stock_list()
        3. 返回分页数据
        """
    
    @staticmethod
    def sync_stock_list(force_update):
        """
        1. 从Tushare获取数据
        2. 批量插入/更新数据库
        3. 返回同步结果
        """
    
    @staticmethod
    def get_daily_data(ts_code, start_date, end_date, limit):
        """
        1. 查询数据库
        2. 如果为空，调用sync_daily_data()
        3. 返回历史数据
        """
    
    @staticmethod
    def sync_daily_data(ts_code, start_date, end_date):
        """
        1. 从Tushare获取数据
        2. 批量插入数据库（去重）
        3. 返回同步结果
        """
```

---

## ⚠️ 注意事项

1. **首次同步需要时间**
   - 5000只股票约需1-2分钟
   - 建议在后台进行

2. **API限制仍然存在**
   - 手动sync操作会调用Tushare
   - 不要频繁手动同步
   - 建议每周最多1次

3. **数据库空间**
   - 股票列表：约1MB
   - 日线数据：约100MB/年
   - 总计不会超过500MB

4. **数据一致性**
   - 数据库数据可能有延迟
   - 重要决策建议手动sync确认

---

**完成时间**: 2025年9月30日  
**版本**: v1.0  
**状态**: ✅ 已实现
