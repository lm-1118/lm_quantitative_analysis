# 📋 数据初始化操作指南

## ✅ 已完成的工作

### 1. 数据库初始化 ✅
- ✅ 创建了28张数据表
- ✅ 包含核心表：`data_source_config`、`stock_basic`、`stock_daily_history`
- ✅ 初始化了默认数据源配置

### 2. 数据缓存服务 ✅
- ✅ 创建 `StockDataService` 实现智能缓存
- ✅ 优先从数据库读取，避免频繁调用Tushare
- ✅ 支持自动同步和手动同步

### 3. API接口 ✅
- ✅ `GET /api/stocks` - 获取股票列表（带缓存）
- ✅ `POST /api/stocks/sync` - 手动同步股票列表
- ✅ `GET /api/stocks/{ts_code}/daily` - 获取日线数据
- ✅ `POST /api/stocks/{ts_code}/daily/sync` - 同步日线数据

---

## 🚀 下一步操作流程

### 步骤1: 启动后端服务

```bash
# 确保在项目目录
cd D:\Murphy\btcquantization\lm_quantitative_analysis

# 启动后端
python run.py
```

**预期输出**:
```
============================================================
🚀 启动 Flask API 服务器...
📡 API地址: http://127.0.0.1:5000/api
🔌 WebSocket地址: ws://127.0.0.1:5000
🌐 允许CORS来源: http://localhost:5173
💡 提示: 按 Ctrl+C 停止服务器
============================================================
```

---

### 步骤2: 启动前端服务

**新开一个终端窗口**:

```bash
# 进入前端目录
cd D:\Murphy\btcquantization\lm_quantitative_analysis\web

# 启动前端
pnpm dev
```

**预期输出**:
```
VITE v5.x.x  ready in xxx ms

➜  Local:   http://localhost:5173/
➜  Network: use --host to expose
```

---

### 步骤3: 配置Tushare Token

1. **打开浏览器** 访问: http://localhost:5173

2. **点击"数据源"标签页**

3. **配置Tushare Pro**:
   - 在Token输入框中输入您的Tushare Token
   - 点击"保存配置"

4. **测试连接**:
   - 点击"测试连接"按钮
   - 等待测试结果（注意：测试接口每小时只能调用1次）

5. **激活数据源**:
   - 点击"激活"按钮
   - 确保显示"已激活"状态

---

### 步骤4: 同步股票列表

#### 方式A: 使用前端（推荐）

在前端"数据源"页面，配置完成后会自动同步

#### 方式B: 使用命令行脚本

**新开一个终端窗口**:

```bash
cd D:\Murphy\btcquantization\lm_quantitative_analysis

# 首次同步
python sync_stock_data.py

# 强制更新（覆盖现有数据）
python sync_stock_data.py --force
```

**预期输出**:
```
============================================================
📊 开始同步股票列表...
============================================================

✅ 同步成功!
   新增: 5000 只股票
   更新: 0 只股票
   总计: 5000 只股票
   来源: tushare

============================================================
```

---

### 步骤5: 验证数据

#### 方式A: API测试

```bash
# 获取股票列表
curl http://127.0.0.1:5000/api/stocks?page=1&page_size=10
```

**预期响应**:
```json
{
  "success": true,
  "data": [
    {
      "ts_code": "000001.SZ",
      "symbol": "000001",
      "name": "平安银行",
      "area": "深圳",
      "industry": "银行",
      "list_date": "1991-04-03"
    },
    ...
  ],
  "total": 5000,
  "page": 1,
  "page_size": 10,
  "total_pages": 500,
  "source": "database"
}
```

#### 方式B: 数据库查询

```sql
-- 查看股票数量
SELECT COUNT(*) FROM stock_basic;

-- 查看前10只股票
SELECT * FROM stock_basic LIMIT 10;
```

---

## 📊 数据同步说明

### 自动缓存机制

```
第一次调用 GET /api/stocks
         ↓
    数据库为空？
         ↓
        是
         ↓
  自动调用Tushare获取
         ↓
    保存到数据库
         ↓
      返回数据
         
第二次调用 GET /api/stocks
         ↓
   直接从数据库读取
         ↓
      秒级响应！
```

### 数据更新频率

| 数据类型 | 推荐更新频率 | 说明 |
|---------|------------|------|
| 股票列表 | 每周1次 | 新股上市频率低 |
| 日线数据 | 按需获取 | 首次访问时自动同步 |
| 实时数据 | 实时推送 | 通过WebSocket |

### Tushare限制

⚠️ **重要提示**:
- `stock_basic` 接口：**每小时只能调用1次**
- `daily` 接口：**每分钟有调用限制**
- 测试连接接口：**每小时只能调用1次**

**解决方案**:
- ✅ 使用数据库缓存，避免频繁调用
- ✅ 只在必要时手动同步
- ✅ 日常使用100%从数据库读取

---

## 🔧 故障排查

### 问题1: 数据库连接失败

**错误**: `Can't connect to MySQL server`

**解决**:
1. 检查MySQL服务是否启动
2. 检查 `config.py` 中的数据库配置
3. 确认用户名密码正确

---

### 问题2: Tushare Token无效

**错误**: `您的token不对，请确认`

**解决**:
1. 访问 https://tushare.pro/
2. 登录账号
3. 在"个人中心"获取Token
4. 重新配置Token

---

### 问题3: 同步失败

**错误**: `没有激活的数据源`

**解决**:
1. 在前端配置Tushare Token
2. 点击"测试连接"
3. 点击"激活"按钮
4. 重新运行同步脚本

---

### 问题4: API调用限制

**错误**: `您每小时最多访问该接口1次`

**解决**:
- ✅ 等待1小时后重试
- ✅ 使用数据库缓存，不再调用API
- ✅ 避免频繁手动同步

---

## 📝 后续工作

### 下一步: 对接前端

完成数据初始化后，需要更新前端组件：

1. **股票列表页面**
   - 替换mock数据
   - 调用 `GET /api/stocks` 获取真实数据
   - 实现分页、筛选功能

2. **K线图表**
   - 调用 `GET /api/stocks/{ts_code}/daily` 获取数据
   - 渲染K线图

3. **实时行情**
   - 使用WebSocket接收实时数据
   - 更新股票价格、涨跌幅

---

## 📂 相关文件

| 文件 | 说明 |
|------|------|
| `init_datasource_db.py` | 数据库初始化脚本 |
| `sync_stock_data.py` | 股票数据同步脚本 |
| `app/services/stock_data_service.py` | 数据缓存服务 |
| `app/services/tushare_service.py` | Tushare API服务 |
| `app/api/stock_routes.py` | 股票数据API路由 |
| `app/models/stock_basic.py` | 股票基本信息模型 |
| `app/models/stock_daily_history.py` | 日线数据模型 |

---

## ✅ 检查清单

在对接前端之前，请确认以下项目都已完成：

- [ ] 数据库初始化成功（28张表）
- [ ] 后端服务启动成功
- [ ] 前端服务启动成功
- [ ] Tushare Token配置成功
- [ ] 数据源连接测试通过
- [ ] 数据源已激活
- [ ] 股票列表同步成功（约5000只）
- [ ] API接口测试成功
- [ ] 数据库中有股票数据

全部完成后即可开始对接前端！

---

**最后更新**: 2025年9月30日  
**版本**: v1.0  
**状态**: ✅ 准备就绪
