# 🎉 前端API对接完成说明

## ✅ 已完成的工作

### 1. API服务层创建
**文件**: `web/src/services/api.js`

封装了所有后端API调用，包括：
- ✅ 数据源管理API（6个接口）
- ✅ 股票数据API（3个接口）
- ✅ 预警规则API（5个接口）

**使用示例**:
```javascript
import { getDataSources, testDataSourceConnection } from '@/services/api';

// 获取数据源列表
const sources = await getDataSources();

// 测试连接
const result = await testDataSourceConnection(1);
```

---

### 2. WebSocket服务创建
**文件**: `web/src/services/websocket.js`

实现了WebSocket连接管理，支持：
- ✅ 自动重连机制
- ✅ 事件订阅/取消订阅
- ✅ 心跳检测
- ✅ 实时数据推送

**使用示例**:
```javascript
import wsService from '@/services/websocket';

// 连接WebSocket
wsService.connect();

// 订阅市场数据
wsService.subscribe('market_data', { symbol: '000001.SZ' });

// 监听数据更新
wsService.on('market_data_update', (data) => {
  console.log('收到实时数据:', data);
});
```

---

### 3. 数据源配置组件
**文件**: `web/src/components/DataSourceConfig.jsx`

**功能**:
- ✅ 显示所有数据源配置
- ✅ 配置Tushare Token
- ✅ 测试数据源连接
- ✅ 激活/停用数据源
- ✅ 删除数据源

**界面截图**:
```
┌─────────────────────────────────────────────┐
│  数据源配置                                  │
├─────────────────────────────────────────────┤
│  📊 Tushare Pro                 [已激活]    │
│  类型: tushare | 最后测试: 2025-09-30      │
│                                             │
│  [配置Token] [测试连接] [激活] [删除]       │
└─────────────────────────────────────────────┘
```

---

### 4. 主仪表板更新
**文件**: `web/src/components/StockDashboard.jsx`

**更新内容**:
- ✅ 导入 `DataSourceConfig` 组件
- ✅ 添加"数据源"标签页
- ✅ 默认打开数据源配置页
- ✅ 更新状态显示为"API模式"

**标签页结构**:
```
[数据源] [实时监控] [预警记录] [预警规则] [策略配置] [Webhook]
   ↑
  默认打开
```

---

### 5. 依赖安装
**新增依赖**:
- ✅ `socket.io-client@4.8.1` - WebSocket客户端

**安装命令**:
```bash
cd web
pnpm add socket.io-client
```

---

## 🚀 如何使用

### 第一步：启动后端服务

```bash
cd D:\Murphy\btcquantization\lm_quantitative_analysis
python run.py
```

**预期输出**:
```
============================================================
🚀 启动 Flask API 服务器...
📡 API地址: http://127.0.0.1:5000/api
🔌 WebSocket地址: ws://127.0.0.1:5000
🌐 允许CORS来源: http://localhost:5173
============================================================
(28724) wsgi starting up on http://0.0.0.0:5000
```

---

### 第二步：启动前端服务

前端应该已经在运行，如果没有：

```bash
cd web
pnpm dev
```

**访问地址**: http://localhost:5173

---

### 第三步：配置数据源

1. **打开浏览器访问** http://localhost:5173
2. **默认会显示"数据源"标签页**
3. **点击"配置Token"按钮**
4. **输入Tushare Token**
   - 访问 https://tushare.pro/ 注册获取
   - 免费版足够个人使用
5. **点击"保存"**
6. **点击"测试连接"**
7. **测试成功后，点击"激活"**

---

## 📸 界面预览

### 数据源配置页面

```
╔════════════════════════════════════════════════════════╗
║  股票异动检测与智能预警系统      [API模式] [●前后端已连接]  ║
╠════════════════════════════════════════════════════════╣
║  [数据源] [实时监控] [预警记录] [预警规则] [策略] [Webhook]  ║
╠════════════════════════════════════════════════════════╣
║                                                        ║
║  📊 数据源配置                                          ║
║  配置和管理股票数据源，支持Tushare Pro等多种数据源           ║
║                                                        ║
║  ┌──────────────────────────────────────────┐        ║
║  │ 📊 Tushare Pro           [已激活]        │        ║
║  │ 类型: tushare | 最后测试: 刚刚             │        ║
║  │                                          │        ║
║  │ [配置Token] [测试连接] [停用]            │        ║
║  └──────────────────────────────────────────┘        ║
║                                                        ║
║  📚 使用说明                                           ║
║  1. 点击"配置Token"按钮，输入您的Tushare Token          ║
║  2. 点击"测试连接"验证Token是否有效                      ║
║  3. 测试成功后，点击"激活"启用该数据源                   ║
║  4. 激活的数据源将自动用于获取股票数据                   ║
║                                                        ║
╚════════════════════════════════════════════════════════╝
```

---

## 🔧 API调用流程

### 数据源配置流程

```
用户操作                API调用                     后端处理
   │                      │                          │
   ├─ 打开页面 ───────→ GET /api/datasources ────→ 返回数据源列表
   │                      │                          │
   ├─ 配置Token ──────→ PUT /api/datasources/1 ──→ 更新配置
   │                      │                          │
   ├─ 测试连接 ──────→ POST /api/datasources/1/test → Tushare连接测试
   │                      │                          │
   └─ 激活数据源 ─────→ PUT /api/datasources/1 ──→ 设置is_active=true
```

---

## 📊 技术架构

```
┌─────────────────────────────────────────────┐
│            前端 (React + Vite)               │
│                                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │   UI层   │  │  服务层  │  │  组件层  │ │
│  │          │  │          │  │          │ │
│  │ Shadcn/UI│←─│  api.js  │←─│Dashboard │ │
│  │ Tailwind │  │  ws.js   │  │DataSource│ │
│  └──────────┘  └──────────┘  └──────────┘ │
│                      │                      │
└──────────────────────┼──────────────────────┘
                       │
                ┌──────┴──────┐
                │             │
           REST API      WebSocket
                │             │
┌───────────────┴─────────────┴────────────────┐
│            后端 (Flask)                       │
│                                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  API层   │  │  服务层  │  │  模型层  │  │
│  │          │  │          │  │          │  │
│  │datasource│→ │ Tushare  │→ │DataSource│  │
│  │  stock   │  │ Service  │  │  Config  │  │
│  │  alert   │  │          │  │          │  │
│  └──────────┘  └──────────┘  └──────────┘  │
│                                 ↓            │
│                         ┌──────────────┐    │
│                         │   MySQL DB   │    │
│                         └──────────────┘    │
└──────────────────────────────────────────────┘
```

---

## ✅ 验证清单

请按照以下清单验证功能是否正常：

- [ ] 后端服务已启动（`python run.py`）
- [ ] 前端服务已运行（访问 http://localhost:5173）
- [ ] "数据源"标签页默认显示
- [ ] 能看到Tushare Pro配置项
- [ ] 点击"配置Token"能弹出输入框
- [ ] 输入Token后能保存
- [ ] 点击"测试连接"有响应（成功或失败提示）
- [ ] 测试成功后能激活数据源
- [ ] 激活后徽章显示"已激活"

---

## 🎯 下一步工作

### 立即可做：
1. **配置Tushare数据源** - 输入Token并激活
2. **测试API连接** - 确保前后端通信正常

### 待实现功能：
1. **实时监控页面** - 对接股票实时数据API
2. **预警规则页面** - 对接预警规则管理API
3. **WebSocket集成** - 实现实时数据推送
4. **图表数据** - 使用真实历史数据替换mock数据

---

## 🐛 常见问题

### Q1: 前端无法连接后端？
**A**: 检查：
1. 后端是否已启动（运行 `python run.py`）
2. 后端地址是否正确（http://localhost:5000/api）
3. CORS是否配置正确（已在`app/__init__.py`中配置）

### Q2: 测试连接失败？
**A**: 检查：
1. Token是否正确（从Tushare官网复制，不要有空格）
2. 网络是否正常
3. Tushare账号是否已激活

### Q3: 点击按钮没有反应？
**A**: 打开浏览器开发者工具（F12）：
1. 查看Console是否有错误
2. 查看Network标签是否有API请求
3. 检查API请求的响应

---

## 📞 技术支持

如有问题，请查看：
- 浏览器Console日志
- 后端服务器日志
- API请求和响应详情

---

**更新时间**: 2025年9月30日  
**版本**: v1.0  
**状态**: ✅ 前端API对接完成

---

**恭喜！前端已成功对接后端API！** 🎉
