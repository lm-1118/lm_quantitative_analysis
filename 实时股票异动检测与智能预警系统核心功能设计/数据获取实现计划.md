# 📊 数据获取实现计划

## 🎯 基于Tushare免费版的实现方案

根据Tushare免费版的能力，我们可以实现以下功能：

---

## ✅ 第一阶段：基础数据（已完成）

### 1. 数据源配置 ✅
- [x] Tushare Token配置
- [x] 连接测试
- [x] 数据源激活

**已实现的API**:
- `GET /api/datasources` - 获取数据源列表
- `POST /api/datasources/{id}/test` - 测试连接
- `PUT /api/datasources/{id}` - 更新配置

---

## 🔄 第二阶段：股票列表与行情（待实现）

### 2.1 股票列表数据

**Tushare接口**: `pro.stock_basic()`

**功能**:
- 获取所有A股上市公司
- 支持按行业筛选
- 支持按地域筛选
- 支持市场类型筛选

**后端需要实现**:
```python
# app/services/tushare_service.py
def get_stock_list(self, exchange='', list_status='L', market=''):
    """
    获取股票列表
    
    参数:
        exchange: 交易所 (SSE/SZSE)
        list_status: 上市状态 (L上市/D退市/P暂停)
        market: 市场类型 (主板/创业板/科创板/北交所)
    """
    df = self.pro.stock_basic(
        exchange=exchange,
        list_status=list_status,
        market=market,
        fields='ts_code,symbol,name,area,industry,market,list_date'
    )
    return df.to_dict('records')
```

**前端接口**: 已存在
- `GET /api/stocks?industry=银行&area=深圳`

**前端展示**:
- 股票列表卡片
- 行业筛选
- 地域筛选
- 搜索功能

---

### 2.2 日线行情数据

**Tushare接口**: `pro.daily()`

**功能**:
- 获取K线数据
- 用于图表展示
- 历史回测

**后端需要实现**:
```python
# app/services/tushare_service.py
def get_daily_data(self, ts_code, start_date=None, end_date=None, limit=60):
    """
    获取日线行情
    
    参数:
        ts_code: 股票代码
        start_date: 开始日期 (YYYYMMDD)
        end_date: 结束日期 (YYYYMMDD)
        limit: 返回最近N天
    """
    if not start_date and not end_date:
        # 如果没有指定日期，返回最近limit天
        end_date = datetime.now().strftime('%Y%m%d')
        start_date = (datetime.now() - timedelta(days=limit*2)).strftime('%Y%m%d')
    
    df = self.pro.daily(
        ts_code=ts_code,
        start_date=start_date,
        end_date=end_date
    )
    return df.to_dict('records')
```

**前端接口**: 已存在
- `GET /api/stocks/{ts_code}/daily?start_date=20231101&end_date=20231130&limit=60`

**前端展示**:
- K线图表（Recharts）
- 成交量柱状图
- 移动平均线

---

### 2.3 每日基本指标（核心！）

**Tushare接口**: `pro.daily_basic()`

**功能**:
- 换手率
- 量比
- 市盈率
- 市值
- **最适合做异动检测**

**后端需要实现**:
```python
# app/services/tushare_service.py
def get_daily_basic(self, ts_code=None, trade_date=None):
    """
    获取每日指标
    
    参数:
        ts_code: 股票代码（可选，不填返回所有）
        trade_date: 交易日期（可选，默认最新）
    """
    if not trade_date:
        trade_date = datetime.now().strftime('%Y%m%d')
    
    df = self.pro.daily_basic(
        ts_code=ts_code,
        trade_date=trade_date,
        fields='ts_code,trade_date,close,turnover_rate,turnover_rate_f,volume_ratio,pe,pe_ttm,pb,ps,total_share,float_share,total_mv,circ_mv'
    )
    return df.to_dict('records')
```

**新增前端接口**:
- `GET /api/stocks/daily-basic?trade_date=20231201` - 获取全市场指标
- `GET /api/stocks/{ts_code}/basic?trade_date=20231201` - 获取单只股票指标

**前端展示**:
- 实时监控页面
- 异动股票列表
- 换手率排行
- 量比排行

---

## 🚨 第三阶段：异动检测与预警（核心功能）

### 3.1 异动检测规则

**基于 `daily_basic` 数据**:

```python
# app/services/anomaly_detection_service.py
class AnomalyDetectionService:
    
    def detect_high_turnover(self, df, threshold=10):
        """换手率异动"""
        return df[df['turnover_rate'] > threshold]
    
    def detect_volume_ratio(self, df, threshold=2):
        """量比异动"""
        return df[df['volume_ratio'] > threshold]
    
    def detect_price_change(self, df, up_threshold=5, down_threshold=-5):
        """价格异动"""
        # 需要对比前一天的收盘价
        return df[(df['pct_chg'] > up_threshold) | (df['pct_chg'] < down_threshold)]
    
    def detect_market_value_change(self, df, threshold=10):
        """市值异动"""
        # 市值大幅变化
        pass
```

**新增API接口**:
- `GET /api/anomaly/high-turnover?threshold=10` - 高换手率
- `GET /api/anomaly/volume-ratio?threshold=2` - 高量比
- `GET /api/anomaly/price-change?up=5&down=-5` - 价格异动

**前端展示**:
- 异动预警卡片
- 实时异动列表
- 异动类型分类（换手率/量比/价格）

---

### 3.2 预警规则管理

**已有的API接口**: ✅
- `GET /api/rules` - 获取规则列表
- `POST /api/rules` - 创建规则
- `PUT /api/rules/{id}` - 更新规则
- `DELETE /api/rules/{id}` - 删除规则
- `GET /api/alerts` - 获取预警记录

**需要实现后端逻辑**:
```python
# app/services/alert_service.py
class AlertService:
    
    def check_rules(self, stock_data, rules):
        """检查股票数据是否触发规则"""
        alerts = []
        
        for rule in rules:
            if not rule.enabled:
                continue
            
            if rule.rule_type == 'price_change':
                # 检查涨跌幅
                if self._check_price_change(stock_data, rule):
                    alerts.append(self._create_alert(stock_data, rule))
            
            elif rule.rule_type == 'volume_spike':
                # 检查成交量异动
                if self._check_volume_spike(stock_data, rule):
                    alerts.append(self._create_alert(stock_data, rule))
            
            elif rule.rule_type == 'turnover_rate':
                # 检查换手率
                if self._check_turnover_rate(stock_data, rule):
                    alerts.append(self._create_alert(stock_data, rule))
        
        return alerts
```

**前端展示**:
- 规则配置表单
- 规则列表
- 启用/禁用开关
- 预警历史记录

---

## 📈 第四阶段：数据可视化

### 4.1 K线图表

**数据来源**: `pro.daily()`

**图表组件**: Recharts

**功能**:
- 日K线/周K线/月K线切换
- MACD指标
- KDJ指标
- 成交量
- 移动平均线（MA5/MA10/MA20）

**前端实现**:
```jsx
// src/components/StockChart.jsx
import { LineChart, Line, CandlestickChart } from 'recharts';

function StockChart({ tsCode }) {
  const [klineData, setKlineData] = useState([]);
  
  useEffect(() => {
    // 获取K线数据
    getStockDailyData(tsCode, { limit: 60 }).then(data => {
      setKlineData(data);
    });
  }, [tsCode]);
  
  return (
    <ResponsiveContainer>
      <LineChart data={klineData}>
        <Line dataKey="close" stroke="#8884d8" />
        <Line dataKey="ma5" stroke="#82ca9d" />
        <Line dataKey="ma10" stroke="#ffc658" />
      </LineChart>
    </ResponsiveContainer>
  );
}
```

---

### 4.2 实时监控面板

**数据来源**: `pro.daily_basic()`

**更新频率**: 每日收盘后（18:00后）

**展示内容**:
- 涨幅榜 Top 10
- 跌幅榜 Top 10
- 换手率榜 Top 10
- 成交额榜 Top 10
- 异动股票列表

---

## 🔄 第五阶段：定时任务

### 5.1 数据更新任务

**使用APScheduler定时任务**:

```python
# app/tasks/data_update.py
from apscheduler.schedulers.background import BackgroundScheduler

scheduler = BackgroundScheduler()

@scheduler.scheduled_job('cron', hour=18, minute=30)
def update_daily_data():
    """每日18:30更新数据"""
    logger.info("开始更新每日数据...")
    
    # 1. 获取交易日历，判断今天是否交易日
    trade_cal = tushare_service.get_trade_cal()
    if not is_trading_day(trade_cal):
        logger.info("今日非交易日，跳过更新")
        return
    
    # 2. 更新股票列表（每周一次）
    if datetime.now().weekday() == 0:
        update_stock_list()
    
    # 3. 更新每日行情
    daily_data = tushare_service.get_daily_basic()
    save_to_database(daily_data)
    
    # 4. 执行异动检测
    anomalies = detect_anomalies(daily_data)
    
    # 5. 检查预警规则
    check_alert_rules(anomalies)
    
    logger.info("每日数据更新完成")

scheduler.start()
```

---

## 📊 数据存储策略

### 6.1 数据库表设计

```sql
-- 股票基本信息表
CREATE TABLE stocks (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ts_code VARCHAR(10) UNIQUE,
    symbol VARCHAR(10),
    name VARCHAR(50),
    area VARCHAR(10),
    industry VARCHAR(20),
    market VARCHAR(10),
    list_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 日线行情表
CREATE TABLE stock_daily (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ts_code VARCHAR(10),
    trade_date DATE,
    open DECIMAL(10,2),
    high DECIMAL(10,2),
    low DECIMAL(10,2),
    close DECIMAL(10,2),
    pre_close DECIMAL(10,2),
    change_amount DECIMAL(10,2),
    pct_chg DECIMAL(6,2),
    vol BIGINT,
    amount DECIMAL(15,2),
    INDEX idx_ts_code_date (ts_code, trade_date)
);

-- 每日指标表
CREATE TABLE stock_daily_basic (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ts_code VARCHAR(10),
    trade_date DATE,
    close DECIMAL(10,2),
    turnover_rate DECIMAL(6,2),
    volume_ratio DECIMAL(6,2),
    pe DECIMAL(10,2),
    pb DECIMAL(10,2),
    total_mv DECIMAL(15,2),
    circ_mv DECIMAL(15,2),
    INDEX idx_ts_code_date (ts_code, trade_date)
);

-- 异动记录表
CREATE TABLE anomaly_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ts_code VARCHAR(10),
    anomaly_type VARCHAR(20),
    trade_date DATE,
    metric_value DECIMAL(10,2),
    threshold_value DECIMAL(10,2),
    severity VARCHAR(10),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 🎯 实现优先级

### P0 - 立即实现（本周）
1. ✅ 数据源配置（已完成）
2. 🔄 股票列表获取
3. 🔄 日线行情获取
4. 🔄 前端K线图表展示

### P1 - 短期实现（下周）
1. 每日指标获取
2. 异动检测逻辑
3. 预警规则管理
4. 实时监控面板

### P2 - 中期实现（下下周）
1. 定时任务
2. 数据库存储
3. 历史数据回测
4. WebSocket实时推送

### P3 - 长期实现（一个月内）
1. 更多技术指标
2. 自定义策略
3. 回测系统
4. 报表导出

---

## 💡 技术要点

### API调用频率控制
```python
import time
from functools import wraps

def rate_limit(calls_per_minute=60):
    """API调用频率限制装饰器"""
    min_interval = 60.0 / calls_per_minute
    last_called = [0.0]
    
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            elapsed = time.time() - last_called[0]
            left_to_wait = min_interval - elapsed
            if left_to_wait > 0:
                time.sleep(left_to_wait)
            ret = func(*args, **kwargs)
            last_called[0] = time.time()
            return ret
        return wrapper
    return decorator

@rate_limit(calls_per_minute=60)
def get_stock_data(ts_code):
    return tushare_service.get_stock_basic()
```

### 数据缓存策略
```python
from functools import lru_cache
from datetime import datetime, timedelta

@lru_cache(maxsize=100)
def get_stock_list_cached():
    """缓存股票列表，每天更新一次"""
    return tushare_service.get_stock_list()

# Redis缓存
def get_daily_data_with_cache(ts_code, trade_date):
    cache_key = f"daily:{ts_code}:{trade_date}"
    
    # 先从缓存获取
    cached_data = redis_client.get(cache_key)
    if cached_data:
        return json.loads(cached_data)
    
    # 缓存未命中，从Tushare获取
    data = tushare_service.get_daily_data(ts_code, trade_date)
    
    # 存入缓存，保存24小时
    redis_client.setex(cache_key, 86400, json.dumps(data))
    
    return data
```

---

## 📝 总结

**免费版Tushare完全可以实现**:
- ✅ 股票列表管理
- ✅ 日线K线图表
- ✅ 异动检测（换手率、量比、涨跌幅）
- ✅ 预警规则管理
- ✅ 历史数据回测

**限制**:
- ❌ 无实时行情（只有日线级别）
- ❌ 无分钟数据
- ❌ 无资金流向数据（需要2000积分）

**推荐使用策略**:
1. 每日收盘后（18:00-19:00）批量更新数据
2. 使用Redis缓存减少API调用
3. 数据库存储历史数据
4. 前端展示缓存数据，提升响应速度

---

**接下来的工作**:
1. 实现股票列表API
2. 实现日线行情API
3. 前端对接这些API
4. 实现K线图表组件
